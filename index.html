<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾³é–€ç¶­ä¿®å ±å·¥åŠ©æ‰‹ - å°ˆæ¥­ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .recording-pulse { animation: pulse 1.5s infinite; background-color: #ef4444 !important; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        /* éš±è—åŸç”Ÿæ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-4 font-sans no-scrollbar">
    <div class="max-w-md mx-auto space-y-4">
        <div class="text-center py-2">
            <h1 class="text-2xl font-black text-blue-800">ğŸ‘·â€â™‚ï¸ ç¶­ä¿®å ±å·¥åŠ©æ‰‹</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest">Mobile Optimized / Local Logic</p>
        </div>

        <button id="micBtn" class="w-full py-10 bg-blue-600 text-white rounded-3xl shadow-xl transition-all flex flex-col items-center justify-center active:scale-95">
            <span id="micIcon" class="text-5xl mb-2">ğŸ¤</span>
            <span id="micText" class="font-bold text-lg">æ’³ä¸€ä¸‹é–‹å§‹éŒ„éŸ³</span>
        </button>

        <div class="bg-white p-4 rounded-2xl shadow-sm border-2 border-dashed border-gray-300">
            <label class="text-xs font-bold text-gray-400 block mb-2">ğŸ”Š éŒ„éŸ³åŸæ–‡å…§å®¹ï¼š</label>
            <div id="rawDisplay" class="text-gray-700 text-sm min-h-[80px] leading-relaxed">
                ç­‰å¾…éŒ„éŸ³ä¸­...
            </div>
        </div>

        <div class="bg-white p-5 rounded-2xl shadow-sm">
            <h2 class="text-sm font-black text-blue-600 border-b pb-2 mb-3">ğŸ“‹ æ•´ç†å¾Œæ•¸æ“š (Excel æ¬„ä½)</h2>
            <div id="fieldsDisplay" class="space-y-2 text-sm">
                </div>
        </div>

        <div class="fixed bottom-6 left-4 right-4 max-w-md mx-auto">
            <button onclick="copyMixedToClipboard()" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black shadow-2xl flex items-center justify-center gap-2 text-lg active:bg-green-700">
                <span>ğŸ“‹</span> è¤‡è£½åˆ° WeChat
            </button>
        </div>
    </div>

    <script>
        // ç²¾ç°¡å¾Œçš„ 11 æ¬„ (ç§»é™¤çµ„åˆ¥ã€ç·¨è™Ÿã€å§“åã€æ›´æ¬¡ã€éƒ¨é–€)
        const headers = ["æ—¥æœŸ", "å·¥å–®è™Ÿç¢¼", "å·¥ä½œåˆ†é¡", "å…§å®¹", "åœ°é»", "æ¥å–®æ™‚é–“", "é–‹å§‹æ™‚é–“", "å®Œå·¥æ™‚é–“", "å·¥å–®ç‹€æ…‹", "Response Time", "Resolution Time"];
        let fieldData = {};
        let rawSpeech = "";
        let isRecording = false;

        // åˆå§‹åŒ– UI
        const fieldsDisplay = document.getElementById('fieldsDisplay');
        headers.forEach(h => {
            fieldsDisplay.innerHTML += `
                <div class="flex justify-between border-b border-gray-50 py-1">
                    <span class="text-gray-400">${h}:</span>
                    <span id="field_${h}" class="font-bold text-gray-800">--</span>
                </div>`;
            fieldData[h] = "--";
        });

        // èªéŸ³è­˜åˆ¥
        const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
        recognition.lang = 'zh-HK';
        recognition.continuous = true;

        document.getElementById('micBtn').onclick = () => {
            if (!isRecording) {
                recognition.start();
                document.getElementById('micBtn').classList.add('recording-pulse');
                document.getElementById('micText').innerText = "ğŸ›‘ è¬›å®Œå†æ’³ä¸€æ¬¡åœæ­¢";
                rawSpeech = "";
            } else {
                recognition.stop();
                document.getElementById('micBtn').classList.remove('recording-pulse');
                document.getElementById('micText').innerText = "ğŸ¤ æ’³ä¸€ä¸‹é–‹å§‹éŒ„éŸ³";
            }
            isRecording = !isRecording;
        };

        recognition.onresult = (event) => {
            rawSpeech = event.results[event.results.length - 1][0].transcript;
            document.getElementById('rawDisplay').innerText = rawSpeech;
            analyzeSpeech(rawSpeech);
        };

        function analyzeSpeech(text) {
            fieldData["æ—¥æœŸ"] = new Date().toLocaleDateString();
            
            // åœ°é»æå– (è­˜åˆ¥æ¨“å±¤)
            const floor = text.match(/(\d+)\s*(æ¨“|f|å­—æ¨“|æˆ¿|é»\d+)/i);
            fieldData["åœ°é»"] = floor ? floor[0].replace('é»', '.') : "--";

            // å·¥ä½œå…§å®¹æå–
            const jobs = ["åŸ·æ²¹", "è£œæ°´æ³¥", "æ¼æ°´", "æ›ç‡ˆ", "å·¡æŸ¥", "ä¿é¤Š", "ç¶­ä¿®"];
            jobs.forEach(j => { if (text.includes(j)) fieldData["å…§å®¹"] = j; });
            fieldData["å·¥ä½œåˆ†é¡"] = text.match(/ä¿é¤Š|å·¡æŸ¥/) ? "PM" : "CMBD";

            // æ™‚é–“é‚è¼¯ (æ”¯æ´å£èª)
            let times = [];
            const timeRegex = /(\d{1,2})[:é»](\d{1,2}|åŠ|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]|[\d])/g;
            let m;
            while ((m = timeRegex.exec(text)) !== null) {
                let hh = m[1].padStart(2, '0');
                let mm = m[2];
                if (mm === "åŠ" || mm === "30") mm = "30";
                else if (mm === "3" || mm === "15") mm = "15"; // ä¹é»ä¸‰
                else if (mm === "6" || mm === "30") mm = "30"; // ä¹é»å…­
                else if (mm === "9" || mm === "45") mm = "45"; // ä¹é»ä¹
                else if (mm.length === 1 && !isNaN(mm)) mm = String(parseInt(mm) * 5).padStart(2, '0');
                else mm = String(mm).padStart(2, '0');
                times.push(`${hh}:${mm}`);
            }

            if (times.length >= 2) {
                fieldData["é–‹å§‹æ™‚é–“"] = times[0];
                fieldData["å®Œå·¥æ™‚é–“"] = times[1];
                const diff = (parseInt(times[1].split(':')[0])*60 + parseInt(times[1].split(':')[1])) - 
                             (parseInt(times[0].split(':')[0])*60 + parseInt(times[0].split(':')[1]));
                fieldData["Resolution Time"] = diff + " åˆ†é˜";
            }
            
            fieldData["å·¥å–®ç‹€æ…‹"] = "å®Œæˆ";
            updateUI();
        }

        function updateUI() {
            headers.forEach(h => {
                document.getElementById(`field_${h}`).innerText = fieldData[h];
            });
        }

        function copyMixedToClipboard() {
            // æ··åˆæ ¼å¼è¼¸å‡ºï¼šåŸæ–‡ + åˆ†éš”ç·š + æ•¸æ“š
            let output = `ã€åŸå§‹éŒ„éŸ³åŸæ–‡ã€‘\n${rawSpeech}\n\n`;
            output += `--------------------\n`;
            output += `ã€æ•´ç†å¾Œæ•¸æ“šã€‘\n`;
            headers.forEach(h => {
                output += `${h}: ${fieldData[h]}\n`;
            });

            navigator.clipboard.writeText(output).then(() => {
                alert("âœ… æˆåŠŸè¤‡è£½ï¼\nåŒ…å«äº†åŸå§‹éŒ„éŸ³åŒåŸ‹ 11 æ¬„æ•¸æ“šã€‚");
            });
        }
    </script>
</body>
</html>