<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥å–®è¨˜éŒ„åŠ©æ‰‹ v3.0</title>
    <style>
        /* ==========================================
           Design System - CSS Variables
           ========================================== */
        :root {
            --color-primary: #2563eb;
            --color-primary-dark: #1d4ed8;
            --color-danger: #dc2626;
            --color-success: #059669;
            --color-warning: #d97706;
            --color-bg: #f8fafc;
            --color-card: #ffffff;
            --color-border: #cbd5e1;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-text-light: #94a3b8;
            --color-highlight: #fef3c7;
            
            --space-1: 4px;
            --space-2: 6px;
            --space-3: 8px;
            --space-4: 12px;
            --space-5: 16px;
            
            --text-xs: 11px;
            --text-sm: 12px;
            --text-base: 13px;
            --text-lg: 14px;
            
            --radius-sm: 3px;
            --radius-md: 4px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: "Microsoft JhengHei", "SimHei", "Heiti TC", sans-serif; 
            background-color: var(--color-bg); 
            font-size: var(--text-base);
            line-height: 1.4;
            color: var(--color-text);
            padding: var(--space-3);
        }

        .container { max-width: 100%; margin: 0 auto; }

        /* ç·Šæ¹Šé ‚éƒ¨å€åŸŸ */
        .header-section {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .header-top {
            display: flex;
            gap: var(--space-3);
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .mic-area {
            text-align: center;
            flex-shrink: 0;
        }

        .btn-mic {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: var(--color-primary);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-mic:hover { background: var(--color-primary-dark); }
        .btn-mic.recording { 
            background: var(--color-danger); 
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        }

        .mic-status {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            margin-top: var(--space-2);
        }

        .input-area { flex: 1; }

        .input-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .input-label {
            font-weight: bold;
            color: var(--color-primary);
            font-size: var(--text-sm);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--text-sm);
            font-weight: bold;
        }

        .btn-primary:hover { background: var(--color-primary-dark); }

        .input-box {
            min-height: 50px;
            background: #f1f5f9;
            border: 2px dashed var(--color-border);
            padding: var(--space-3);
            border-radius: var(--radius-md);
            font-size: var(--text-lg);
            line-height: 1.5;
        }

        .input-hint {
            font-size: var(--text-xs);
            color: var(--color-text-light);
            margin-top: var(--space-2);
        }

        /* è§£æåé¥‹å€ */
        .parse-feedback {
            background: #eff6ff;
            border-left: 3px solid var(--color-primary);
            padding: var(--space-3);
            margin-top: var(--space-3);
            font-size: var(--text-sm);
        }

        .parse-feedback.hidden { display: none; }

        .parse-title {
            font-weight: bold;
            margin-bottom: var(--space-2);
        }

        .parse-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
        }

        .parse-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-1) 0;
            border-bottom: 1px dotted #dbeafe;
        }

        .parse-label { color: var(--color-primary); font-weight: bold; }
        .parse-value { color: var(--color-text); }

        .original-text {
            margin-top: var(--space-3);
            padding: var(--space-2);
            background: white;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .original-text-label {
            font-weight: bold;
            color: var(--color-text);
            margin-bottom: var(--space-1);
        }

        /* è¡¨æ ¼å€åŸŸ - ç·Šæ¹Šè¨­è¨ˆ */
        .table-section {
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: #f1f5f9;
            border-bottom: 1px solid var(--color-border);
        }

        .table-title {
            font-weight: bold;
            font-size: var(--text-sm);
        }

        .table-actions {
            display: flex;
            gap: var(--space-2);
        }

        .btn-sm {
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
        }

        .btn-add { background: var(--color-primary); color: white; }
        .btn-copy { background: var(--color-success); color: white; }

        /* è¡¨æ ¼æœ¬é«” */
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--text-xs);
            table-layout: fixed;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: #e2e8f0;
            padding: var(--space-2);
            text-align: left;
            font-weight: bold;
            color: var(--color-text-muted);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
            z-index: 10;
        }

        .data-table td {
            padding: var(--space-1) var(--space-2);
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        .data-table tr:hover { background: #f8fafc; }

        /* æ¬„ä½å¯¬åº¦å„ªåŒ– */
        .col-seq { width: 30px; }
        .col-date { width: 80px; }
        .col-group { width: 40px; }
        .col-empid { width: 60px; }
        .col-name { width: 50px; }
        .col-shift { width: 70px; }
        .col-wono { width: 80px; }
        .col-dept { width: 60px; }
        .col-type { width: 50px; }
        .col-content { width: 120px; }
        .col-location { width: 100px; }
        .col-time { width: 70px; }
        .col-status { width: 50px; }
        .col-ot { width: 40px; }
        .col-resp { width: 70px; }
        .col-res { width: 70px; }
        .col-action { width: 40px; }

        .table-input {
            width: 100%;
            border: 1px solid #cbd5e1;
            padding: 2px 4px;
            font-size: var(--text-xs);
            font-family: inherit;
            border-radius: var(--radius-sm);
        }

        .table-input:focus {
            border-color: var(--color-primary);
            outline: none;
            background: var(--color-highlight);
        }

        .cell-highlight {
            background: var(--color-highlight);
        }

        .cell-hours {
            text-align: center;
            font-weight: bold;
            color: var(--color-primary);
        }

        .btn-delete {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: var(--text-sm);
        }

        /* åº•éƒ¨çµ±è¨ˆ */
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: #f1f5f9;
            border-top: 1px solid var(--color-border);
        }

        .total-display {
            text-align: right;
        }

        .total-number {
            font-size: var(--text-lg);
            color: var(--color-danger);
            font-weight: bold;
        }

        .total-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        /* æç¤ºè¨Šæ¯ */
        .alert {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }

        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 1200px) {
            .parse-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æç¤ºè¨Šæ¯ -->
        <div id="alertBox" class="alert"></div>

        <!-- é ‚éƒ¨è¼¸å…¥å€ -->
        <div class="header-section">
            <div class="header-top">
                <div class="mic-area">
                    <button id="micBtn" class="btn-mic" title="é–‹å§‹/åœæ­¢éŒ„éŸ³">ğŸ¤</button>
                    <div id="micStatus" class="mic-status">æ’³ä¸€ä¸‹éŒ„éŸ³</div>
                </div>
                <div class="input-area">
                    <div class="input-header">
                        <span class="input-label">ğŸ™ï¸ èªéŸ³è¼¸å…¥ / æ‰‹å‹•è¼¸å…¥ï¼š</span>
                        <button onclick="parseAndFill()" class="btn-primary">ğŸš€ åˆ†æä¸¦å¡«è¡¨</button>
                    </div>
                    <div id="inputDisplay" class="input-box" contenteditable="true">
                        è«‹èªªè©±æˆ–è¼¸å…¥å…§å®¹...
                    </div>
                    <div class="input-hint">
                        ç¯„ä¾‹ï¼šã€Œä»Šæœå…«é»ä¸‰å»16æ¨“å¯«å­—æ¨“é–‹æ—©æœƒã€æˆ–ã€Œåé»åŠé¢¨å‘³å±…æ•´å†·æ°£å…©å€‹é˜ã€
                    </div>
                </div>
            </div>

            <!-- è§£æåé¥‹ -->
            <div id="parseFeedback" class="parse-feedback hidden">
                <div class="parse-title">ğŸ“ AI è§£æçµæœï¼š</div>
                <div id="parseDetails" class="parse-grid"></div>
                <div class="original-text">
                    <div class="original-text-label">ğŸ“„ åŸæ–‡å‚™ä»½ï¼ˆä¾›åƒè€ƒï¼‰ï¼š</div>
                    <div id="originalText"></div>
                </div>
            </div>
        </div>

        <!-- è¡¨æ ¼å€åŸŸ -->
        <div class="table-section">
            <div class="table-header">
                <span class="table-title">ğŸ“‹ å·¥å–®è¨˜éŒ„è¡¨ï¼ˆ18æ¬„æ¨™æº–æ ¼å¼ï¼‰</span>
                <div class="table-actions">
                    <button onclick="addNewRow()" class="btn-sm btn-add">â• æ–°å¢è¡Œ</button>
                    <button onclick="copyToExcel()" class="btn-sm btn-copy">ğŸ“‹ è¤‡è£½å…¨éƒ¨</button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table" id="workTable">
                    <thead>
                        <tr>
                            <th class="col-seq">#</th>
                            <th class="col-date">æ—¥æœŸ</th>
                            <th class="col-group">çµ„åˆ«</th>
                            <th class="col-empid">å“¡å·¥ç·¨å·</th>
                            <th class="col-name">å§“å</th>
                            <th class="col-shift">æ›´</th>
                            <th class="col-wono">å·¥å–®å·ç¢¼</th>
                            <th class="col-dept">éƒ¨é–€</th>
                            <th class="col-type">å·¥ä½œåˆ†é¡</th>
                            <th class="col-content">å†…å®¹</th>
                            <th class="col-location">åœ°é»</th>
                            <th class="col-time">æ¥å–®æ™‚é–“</th>
                            <th class="col-time">é–‹å§‹</th>
                            <th class="col-time">å®Œæˆ</th>
                            <th class="col-status">ç‹€æ…‹</th>
                            <th class="col-ot">OT</th>
                            <th class="col-resp">Response</th>
                            <th class="col-res">Resolution</th>
                            <th class="col-action">åˆª</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div class="table-footer">
                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">
                    ğŸ’¡ æç¤ºï¼šé»ƒè‰²æ¬„ä½ç‚ºé—œéµæ¬„ä½ï¼Œè«‹ä»”ç´°æ ¸å°
                </div>
                <div class="total-display">
                    <span class="total-label">ç¸½å·¥æ™‚ï¼š</span>
                    <span id="totalHours" class="total-number">0.0</span>
                    <span class="total-label">å°æ™‚</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // é…ç½®èˆ‡é è¨­å€¼ï¼ˆåŸºæ–¼ Excel æ¨£æœ¬ï¼‰
        // ==========================================
        
        var DEFAULT_VALUES = {
            group: 'BD',
            empId: '7620',
            name: 'å ¯',
            shift: '08:45:00',
            status: 'å®Œæˆ',
            ot: 'No',
            responseTime: '00:05:00',
            defaultDuration: 90  // 1.5å°æ™‚ = 90åˆ†é˜
        };

        // åœ°é»é—œéµè©ï¼ˆç°¡åŒ–ç‰ˆï¼Œå»é™¤æ•æ„Ÿå­—æ¨£ï¼‰
        var LOCATION_MAP = [
            { keys: ['16æ¨“', '16F', 'å¯«å­—æ¨“', 'è¾¦å…¬å®¤', 'å·¥ç¨‹éƒ¨'], location: '16F å¯«å­—æ¨“', dept: 'å·¥ç¨‹' },
            { keys: ['6æ¨“', '6F', 'å¹³å°'], location: '6F å¹³å°', dept: 'F&B' },
            { keys: ['B2', 'åœ°åº«', 'è²¨å€‰'], location: 'B2', dept: 'HR&A' },
            { keys: ['Gæ¨“', 'GF', 'å¤§å ‚', 'Passion'], location: 'G/F Passion', dept: 'F&B' },
            { keys: ['1æ¨“', '1F', 'ç¿ è¯'], location: '1/F ç¿ è¯é¤å»³', dept: 'F&B' },
            { keys: ['5æ¨“', '5F', 'é¢¨å‘³', 'é¢¨å‘³å±…'], location: '5/F é¢¨å‘³å±…', dept: 'F&B' },
            { keys: ['10æ¨“', '10F', 'å”æˆ', 'ç«é‹'], location: '10/F å”æˆç«é‹', dept: 'F&B' },
            { keys: ['17æ¨“', '17F', 'æ³³æ± ', 'å¥èº«'], location: '17/F æ³³æ± ', dept: 'Leisure' }
        ];

        // å·¥ä½œåˆ†é¡é—œéµè©
        var TYPE_MAP = [
            { keys: ['æ—©æœƒ', 'ç¸½æœƒ', 'é–‹æœƒ', 'æœƒè­°', 'briefing', 'æ™¨æœƒ'], type: 'CMBD' },
            { keys: ['ä¿é¤Š', 'PM', 'é é˜²', 'ä¾‹è¡Œ', 'æª¢æŸ¥', 'ç¶­è­·'], type: 'PM' },
            { keys: ['ç¶­ä¿®', 'ä¿®ç†', 'æ•´', 'æ›', 'è£œ', 'å®‰è£', 'æ•…éšœ'], type: 'CMBD' }
        ];

        // ç‹€æ…‹ç®¡ç†
        var workData = [];
        var nextId = 1;
        var isRecording = false;
        var recognition = null;
        var lastInputText = '';

        // ==========================================
        // å·¥å…·å‡½æ•¸
        // ==========================================
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }

        function showAlert(message, type, duration) {
            duration = duration || 3000;
            var alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert alert-' + type;
            alertBox.innerHTML = message;
            alertBox.style.display = 'block';
            
            setTimeout(function() {
                alertBox.style.display = 'none';
            }, duration);
        }

        function getTodayDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }

        // Excel æ—¥æœŸåºåˆ—è™Ÿè½‰æ›ï¼ˆå¦‚éœ€ï¼‰
        function dateToSerial(dateStr) {
            if (!dateStr) return '';
            var parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            
            var year = parseInt(parts[0], 10);
            var month = parseInt(parts[1], 10);
            var day = parseInt(parts[2], 10);
            
            // ç°¡åŒ–ï¼šç›´æ¥è¿”å›æ—¥æœŸå­—ä¸²ï¼ŒExcel æœƒè‡ªå‹•è­˜åˆ¥
            return dateStr;
        }

        // ==========================================
        // å»£æ±è©±æ™‚é–“è§£æï¼ˆæ ¸å¿ƒï¼‰
        // ==========================================
        
        function parseCantoneseTime(text) {
            if (!text) return '';
            
            // æ¸…ç†æ–‡å­—
            text = text.replace(/\s/g, '');
            
            // åŒ¹é…æ¨¡å¼ï¼ˆä¾å„ªå…ˆåºï¼‰
            var patterns = [
                // ä»Šæœ/ä»Šæ—¥/å°‹æ—¥ + æ™‚é–“
                /(?:ä»Šæœ|ä»Šæ—¥|å°‹æ—¥|è½æ—¥)?.*?(\d{1,2})[é»:](\d{1,2}|[åŠä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å])/,
                // ç´”æ•¸å­—æ™‚é–“
                /(\d{1,2})[é»:](\d{2})/,
                // ä¸­æ–‡æ™‚é–“
                /([ä¸€äºŒå…©ä¸‰å››äº”å…­ä¸ƒå…«ä¹å]{1,2})[é»:]([åŠä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d])/
            ];
            
            for (var i = 0; i < patterns.length; i++) {
                var match = text.match(patterns[i]);
                if (match) {
                    var hour = parseChineseNumber(match[1]);
                    var minute = parseMinute(match[2]);
                    
                    if (hour >= 0 && hour < 24 && minute >= 0 && minute < 60) {
                        return formatTime(hour, minute);
                    }
                }
            }
            
            return '';
        }

        function parseChineseNumber(str) {
            var map = {
                'ä¸€': 1, 'äºŒ': 2, 'å…©': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5,
                'å…­': 6, 'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
                'åä¸€': 11, 'åäºŒ': 12
            };
            
            if (map[str]) return map[str];
            var num = parseInt(str, 10);
            return isNaN(num) ? 0 : num;
        }

        function parseMinute(str) {
            if (str === 'åŠ') return 30;
            if (str === 'æ­£' || !str) return 0;
            
            // è™•ç†ã€Œå­—ã€ï¼ˆ5åˆ†é˜ä¸€æ ¼ï¼‰
            var cnNum = parseChineseNumber(str);
            if (cnNum > 0 && cnNum <= 12) {
                // 1-12 å‡å®šç‚ºã€Œå­—ã€
                return cnNum * 5;
            }
            
            var num = parseInt(str, 10);
            return isNaN(num) ? 0 : num;
        }

        function formatTime(hour, minute) {
            var h = String(hour).padStart(2, '0');
            var m = String(minute).padStart(2, '0');
            return h + ':' + m + ':00';
        }

        function parseDuration(text) {
            // åŒ¹é…ï¼šå…©å€‹é˜ã€2å°æ™‚ã€1.5å°æ™‚ã€90åˆ†é˜ã€åŠå€‹é˜
            var patterns = [
                { regex: /(\d+\.?\d*)\s*(å°æ™‚|hr|h|å€‹é˜|ç²’é˜)/, mult: 60 },
                { regex: /(ä¸€å€‹åŠ|åŠ|ä¸€|å…©|äºŒ|ä¸‰|å››|äº”|å…­|ä¸ƒ|å…«|ä¹|å)\s*(å€‹åŠå°æ™‚|å€‹é˜|ç²’é˜|å°æ™‚)/, mult: 60 },
                { regex: /(\d+)\s*åˆ†é˜?/, mult: 1 }
            ];
            
            var map = {
                'ä¸€å€‹åŠ': 90, 'åŠ': 30, 'ä¸€': 60, 'å…©': 120, 'äºŒ': 120,
                'ä¸‰': 180, 'å››': 240, 'äº”': 300, 'å…­': 360, 'ä¸ƒ': 420,
                'å…«': 480, 'ä¹': 540, 'å': 600
            };
            
            for (var i = 0; i < patterns.length; i++) {
                var match = text.match(patterns[i].regex);
                if (match) {
                    var val = match[1];
                    if (!isNaN(parseFloat(val))) {
                        return Math.round(parseFloat(val) * patterns[i].mult);
                    }
                    if (map[val]) {
                        return map[val];
                    }
                }
            }
            
            // é è¨­ 1.5 å°æ™‚
            return DEFAULT_VALUES.defaultDuration;
        }

        // ==========================================
        // æ ¸å¿ƒè§£æé‚è¼¯
        // ==========================================
        
        function parseInputText(text) {
            var result = {
                orderTime: '',
                duration: DEFAULT_VALUES.defaultDuration,
                location: '',
                department: '',
                workType: 'CMBD',
                content: '',
                originalText: text,
                parsedItems: []
            };
            
            if (!text || text.trim() === '' || text === 'è«‹èªªè©±æˆ–è¼¸å…¥å…§å®¹...') {
                return result;
            }
            
            text = text.trim();
            lastInputText = text;
            
            // 1. è§£ææ™‚é–“ï¼ˆéŒ¨é»ï¼‰
            result.orderTime = parseCantoneseTime(text);
            if (result.orderTime) {
                result.parsedItems.push({ label: 'æ¥å–®æ™‚é–“', value: result.orderTime });
            } else {
                // ç„¡æ™‚é–“æ™‚ä½¿ç”¨é è¨­
                result.orderTime = DEFAULT_VALUES.shift;
                result.parsedItems.push({ label: 'æ¥å–®æ™‚é–“', value: result.orderTime + ' (é è¨­)' });
            }
            
            // 2. è§£æåœ°é»
            for (var i = 0; i < LOCATION_MAP.length; i++) {
                var loc = LOCATION_MAP[i];
                for (var j = 0; j < loc.keys.length; j++) {
                    if (text.indexOf(loc.keys[j]) !== -1) {
                        result.location = loc.location;
                        result.department = loc.dept;
                        result.parsedItems.push({ label: 'åœ°é»', value: loc.location });
                        result.parsedItems.push({ label: 'éƒ¨é–€', value: loc.dept });
                        break;
                    }
                }
                if (result.location) break;
            }
            
            // 3. è§£æå·¥ä½œåˆ†é¡
            for (var t = 0; t < TYPE_MAP.length; t++) {
                var type = TYPE_MAP[t];
                for (var k = 0; k < type.keys.length; k++) {
                    if (text.indexOf(type.keys[k]) !== -1) {
                        result.workType = type.type;
                        result.parsedItems.push({ label: 'å·¥ä½œåˆ†é¡', value: type.type });
                        break;
                    }
                }
                if (result.workType !== 'CMBD') break;
            }
            
            // 4. è§£æå·¥ä½œå…§å®¹ï¼ˆæå–å‹•è©å¾Œçš„é—œéµè©ï¼‰
            var contentPatterns = [
                /(?:åš|æ•´|ä¿®|æª¢æŸ¥|è™•ç†|å®‰è£|æ›´æ›|æ¸…æ½”|ç¶­ä¿®|è£œ|é–‹|æ)\s*([\u4e00-\u9fa5]{2,8})/,
                /(?:é—œæ–¼|æœ‰é—œ)\s*([\u4e00-\u9fa5]{2,8})/,
                /([\u4e00-\u9fa5]{2,6})(?:å•é¡Œ|æ•…éšœ|ç¶­ä¿®|ä¿é¤Š)/
            ];
            
            for (var p = 0; p < contentPatterns.length; p++) {
                var match = text.match(contentPatterns[p]);
                if (match) {
                    var candidate = match[1];
                    // æ’é™¤åœ°é»é—œéµè©
                    var isLoc = false;
                    for (var m = 0; m < LOCATION_MAP.length; m++) {
                        for (var n = 0; n < LOCATION_MAP[m].keys.length; n++) {
                            if (LOCATION_MAP[m].keys[n] === candidate) {
                                isLoc = true;
                                break;
                            }
                        }
                    }
                    if (!isLoc) {
                        result.content = candidate;
                        result.parsedItems.push({ label: 'å·¥ä½œå…§å®¹', value: candidate });
                        break;
                    }
                }
            }
            
            // 5. è§£ææ™‚é•·
            var dur = parseDuration(text);
            if (dur !== DEFAULT_VALUES.defaultDuration) {
                result.duration = dur;
                var hours = Math.floor(dur / 60);
                var mins = dur % 60;
                var timeStr = hours > 0 ? hours + 'å°æ™‚' : '';
                if (mins > 0) timeStr += mins + 'åˆ†';
                result.parsedItems.push({ label: 'é è¨ˆæ™‚é•·', value: timeStr });
            } else {
                result.parsedItems.push({ label: 'é è¨ˆæ™‚é•·', value: '1.5å°æ™‚ (é è¨­)' });
            }
            
            return result;
        }

        // ==========================================
        // æ™‚é–“è¨ˆç®—ï¼ˆæ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼‰
        // ==========================================
        
        function calculateTimes(orderTime, durationMinutes) {
            // æ¥å–®æ™‚é–“ â†’ é–‹å§‹æ™‚é–“ï¼ˆ+5åˆ†é˜ Response Timeï¼‰
            // â†’ å®Œæˆæ™‚é–“ï¼ˆ+é è¨­å·¥æ™‚ï¼‰
            
            var orderMin = timeToMinutes(orderTime);
            var startMin = orderMin + 5;  // 5åˆ†é˜ Response Time
            var endMin = startMin + durationMinutes;
            
            return {
                orderTime: minutesToTime(orderMin),
                startTime: minutesToTime(startMin),
                endTime: minutesToTime(endMin),
                responseTime: '00:05:00',
                resolutionTime: minutesToDuration(durationMinutes + 5)
            };
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            var parts = timeStr.split(':');
            return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
        }

        function minutesToTime(minutes) {
            minutes = minutes % (24 * 60);
            if (minutes < 0) minutes += 24 * 60;
            
            var h = Math.floor(minutes / 60);
            var m = minutes % 60;
            return formatTime(h, m);
        }

        function minutesToDuration(minutes) {
            var h = Math.floor(minutes / 60);
            var m = minutes % 60;
            return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0') + ':00';
        }

        // ==========================================
        // è³‡æ–™å¡«å……
        // ==========================================
        
        function fillDataFromParse(parseResult) {
            // è¨ˆç®—æ™‚é–“
            var times = calculateTimes(parseResult.orderTime, parseResult.duration);
            
            // å°‹æ‰¾æˆ–å»ºç«‹ç›®æ¨™è¡Œ
            var targetRow = null;
            var isNewRow = false;
            
            if (workData.length > 0) {
                var lastRow = workData[workData.length - 1];
                // æª¢æŸ¥æœ€å¾Œä¸€è¡Œæ˜¯å¦ç‚ºç©ºï¼ˆç„¡å…§å®¹å’Œåœ°é»ï¼‰
                if (!lastRow.content && !lastRow.location) {
                    targetRow = lastRow;
                }
            }
            
            if (!targetRow) {
                targetRow = createEmptyRow();
                workData.push(targetRow);
                isNewRow = true;
            }
            
            // å¡«å……è³‡æ–™ï¼ˆåªè¦†è“‹ AI è­˜åˆ¥åˆ°çš„ï¼Œä¿ç•™ç”¨æˆ¶é è¨­å€¼ï¼‰
            targetRow.date = getTodayDate();
            if (parseResult.location) targetRow.location = parseResult.location;
            if (parseResult.department) targetRow.dept = parseResult.department;
            if (parseResult.workType) targetRow.type = parseResult.workType;
            if (parseResult.content) targetRow.content = parseResult.content;
            
            // æ™‚é–“æ¬„ä½ï¼ˆæ ¸å¿ƒï¼‰
            targetRow.orderTime = times.orderTime;
            targetRow.startTime = times.startTime;
            targetRow.endTime = times.endTime;
            targetRow.responseTime = times.responseTime;
            targetRow.resTime = times.resolutionTime;
            
            // æ¸²æŸ“
            renderTable();
            showParseFeedback(parseResult);
            
            var msg = isNewRow ? 'å·²æ–°å¢è¨˜éŒ„' : 'å·²æ›´æ–°è¨˜éŒ„';
            showAlert(msg + 'ï¼Œè«‹æ ¸å°é»ƒè‰²æ¨™è¨˜æ¬„ä½', 'success');
            
            return true;
        }

        function showParseFeedback(parseResult) {
            var feedbackDiv = document.getElementById('parseFeedback');
            var detailsDiv = document.getElementById('parseDetails');
            var originalDiv = document.getElementById('originalText');
            
            if (parseResult.parsedItems.length === 0) {
                feedbackDiv.className = 'parse-feedback hidden';
                return;
            }
            
            // é¡¯ç¤ºè§£æé …ç›®
            var html = '';
            for (var i = 0; i < parseResult.parsedItems.length; i++) {
                var item = parseResult.parsedItems[i];
                html += '<div class="parse-item">';
                html += '<span class="parse-label">' + escapeHtml(item.label) + '</span>';
                html += '<span class="parse-value">' + escapeHtml(item.value) + '</span>';
                html += '</div>';
            }
            
            // é¡¯ç¤ºæœªè­˜åˆ¥é …ç›®
            var missing = [];
            if (!parseResult.location) missing.push('åœ°é»');
            if (!parseResult.content) missing.push('å·¥ä½œå…§å®¹');
            
            if (missing.length > 0) {
                html += '<div style="grid-column: 1/-1; margin-top: 8px; color: var(--color-warning); font-size: var(--text-xs);">';
                html += 'âš ï¸ æœªè­˜åˆ¥: ' + missing.join('ã€') + 'ï¼ˆè«‹æ‰‹å‹•å¡«å¯«ï¼‰';
                html += '</div>';
            }
            
            detailsDiv.innerHTML = html;
            originalDiv.innerHTML = escapeHtml(parseResult.originalText);
            feedbackDiv.className = 'parse-feedback';
        }

        // ==========================================
        // è¡¨æ ¼æ“ä½œ
        // ==========================================
        
        function createEmptyRow() {
            return {
                id: nextId++,
                date: getTodayDate(),
                group: DEFAULT_VALUES.group,
                empId: DEFAULT_VALUES.empId,
                name: DEFAULT_VALUES.name,
                shift: DEFAULT_VALUES.shift,
                woNo: '',
                dept: '',
                type: 'CMBD',
                content: '',
                location: '',
                orderTime: '',
                startTime: '',
                endTime: '',
                status: DEFAULT_VALUES.status,
                ot: DEFAULT_VALUES.ot,
                responseTime: DEFAULT_VALUES.responseTime,
                resTime: ''
            };
        }

        function initData() {
            workData.push(createEmptyRow());
            renderTable();
        }

        function renderTable() {
            var tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            for (var i = 0; i < workData.length; i++) {
                var row = workData[i];
                var tr = document.createElement('tr');
                tr.id = 'row-' + i;
                
                // è¨ˆç®—å·¥æ™‚
                var hours = calculateWorkHours(row.startTime, row.endTime);
                
                // å»ºç«‹å„æ¬„ä½
                var cells = [
                    { key: 'id', val: row.id, editable: false, width: 'col-seq' },
                    { key: 'date', val: row.date, highlight: true },
                    { key: 'group', val: row.group },
                    { key: 'empId', val: row.empId },
                    { key: 'name', val: row.name },
                    { key: 'shift', val: row.shift },
                    { key: 'woNo', val: row.woNo || '' },
                    { key: 'dept', val: row.dept || '', highlight: true },
                    { key: 'type', val: row.type },
                    { key: 'content', val: row.content || '', highlight: true },
                    { key: 'location', val: row.location || '', highlight: true },
                    { key: 'orderTime', val: row.orderTime || '', highlight: true },
                    { key: 'startTime', val: row.startTime || '' },
                    { key: 'endTime', val: row.endTime || '' },
                    { key: 'status', val: row.status },
                    { key: 'ot', val: row.ot },
                    { key: 'responseTime', val: row.responseTime, editable: false },
                    { key: 'resTime', val: row.resTime || '', editable: false },
                    { key: 'action', val: '', isAction: true }
                ];
                
                for (var c = 0; c < cells.length; c++) {
                    var cell = cells[c];
                    var td = document.createElement('td');
                    if (cell.width) td.className = cell.width;
                    
                    if (cell.isAction) {
                        td.innerHTML = '<button onclick="deleteRow(' + i + ')" class="btn-delete">ğŸ—‘</button>';
                    } else if (cell.editable !== false) {
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'table-input' + (cell.highlight ? ' cell-highlight' : '');
                        input.value = cell.val;
                        input.setAttribute('data-row', i);
                        input.setAttribute('data-col', cell.key);
                        input.onchange = function() {
                            updateRowData(parseInt(this.getAttribute('data-row'), 10), 
                                         this.getAttribute('data-col'), 
                                         this.value);
                        };
                        td.appendChild(input);
                    } else {
                        td.textContent = cell.val;
                        if (cell.key === 'id') td.style.fontWeight = 'bold';
                    }
                    
                    tr.appendChild(td);
                }
                
                // å·¥æ™‚æ¬„ä½ï¼ˆè¨ˆç®—å€¼ï¼‰
                var hoursTd = document.createElement('td');
                hoursTd.className = 'cell-hours';
                hoursTd.innerHTML = '<span id="hours-' + i + '">' + hours.toFixed(1) + '</span>';
                tr.appendChild(hoursTd);
                
                tbody.appendChild(tr);
            }
            
            calculateTotalHours();
        }

        function updateRowData(index, field, value) {
            workData[index][field] = value;
            
            // å¦‚æœä¿®æ”¹æ™‚é–“ï¼Œé‡æ–°è¨ˆç®—å·¥æ™‚
            if (field === 'startTime' || field === 'endTime' || field === 'orderTime') {
                // å¦‚æœæ”¹çš„æ˜¯æ¥å–®æ™‚é–“ï¼Œé€£å‹•æ›´æ–°é–‹å§‹å’Œå®Œæˆæ™‚é–“
                if (field === 'orderTime' && value) {
                    var times = calculateTimes(value, DEFAULT_VALUES.defaultDuration);
                    workData[index].startTime = times.startTime;
                    workData[index].endTime = times.endTime;
                    workData[index].responseTime = times.responseTime;
                    workData[index].resTime = times.resolutionTime;
                    
                    // æ›´æ–°é¡¯ç¤º
                    renderTable();
                    return;
                }
                
                var hours = calculateWorkHours(workData[index].startTime, workData[index].endTime);
                var hoursCell = document.getElementById('hours-' + index);
                if (hoursCell) hoursCell.textContent = hours.toFixed(1);
                calculateTotalHours();
            }
        }

        function calculateWorkHours(start, end) {
            if (!start || !end) return 0;
            var s = timeToMinutes(start);
            var e = timeToMinutes(end);
            if (e < s) e += 24 * 60; // è·¨åˆå¤œ
            return (e - s) / 60;
        }

        function calculateTotalHours() {
            var total = 0;
            for (var i = 0; i < workData.length; i++) {
                total += calculateWorkHours(workData[i].startTime, workData[i].endTime);
            }
            document.getElementById('totalHours').textContent = total.toFixed(1);
        }

        function deleteRow(index) {
            if (confirm('ç¢ºå®šåˆªé™¤ç¬¬ ' + workData[index].id + ' è¡Œï¼Ÿ')) {
                workData.splice(index, 1);
                if (workData.length === 0) {
                    workData.push(createEmptyRow());
                }
                renderTable();
            }
        }

        function addNewRow() {
            workData.push(createEmptyRow());
            renderTable();
            showAlert('å·²æ–°å¢ç©ºç™½è¡Œ', 'success', 2000);
        }

        // ==========================================
        // èªéŸ³è¼¸å…¥
        // ==========================================
        
        function initSpeechRecognition() {
            var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            var statusDiv = document.getElementById('micStatus');
            
            if (!SpeechRecognition) {
                statusDiv.innerHTML = 'âŒ ä¸æ”¯æ´';
                document.getElementById('micBtn').style.display = 'none';
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-HK';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('micBtn').className = 'btn-mic recording';
                statusDiv.innerHTML = 'éŒ„éŸ³ä¸­...';
            };
            
            recognition.onresult = function(event) {
                var transcript = '';
                for (var i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('inputDisplay').textContent = transcript;
            };
            
            recognition.onerror = function(event) {
                console.error('èªéŸ³éŒ¯èª¤:', event.error);
                statusDiv.innerHTML = 'éŒ¯èª¤: ' + event.error;
                stopRecording();
            };
            
            recognition.onend = function() {
                stopRecording();
            };
            
            document.getElementById('micBtn').onclick = function() {
                if (isRecording) {
                    recognition.stop();
                } else {
                    recognition.start();
                }
            };
        }

        function stopRecording() {
            isRecording = false;
            document.getElementById('micBtn').className = 'btn-mic';
            document.getElementById('micStatus').innerHTML = 'æ’³ä¸€ä¸‹éŒ„éŸ³';
        }

        // ==========================================
        // åŒ¯å‡ºåŠŸèƒ½ï¼ˆé—œéµï¼šåŒ¹é… Excel æ ¼å¼ï¼‰
        // ==========================================
        
        function copyToExcel() {
            if (workData.length === 0) {
                showAlert('ç„¡è³‡æ–™å¯å¤åˆ¶', 'warning');
                return;
            }
            
            // åš´æ ¼æŒ‰ç…§ Excel æ¨£æœ¬çš„ 18 æ¬„é †åº
            var headers = ['#', 'æ—¥æœŸ', 'çµ„åˆ«', 'å“¡å·¥ç·¨å·', 'å§“å', 'æ›´', 'å·¥å–®å·ç¢¼', 
                        'éƒ¨é–€', 'å·¥ä½œåˆ†é¡', 'å†…å®¹', 'åœ°é»', 'æ¥å–®æ™‚é–“', 'é–‹å§‹', 'å®Œæˆ', 
                        'å·¥å–®ç‹€æ…‹', 'OT', 'Response Time', 'Resolution Time'];
            
            var lines = [headers.join('\t')];
            
            for (var i = 0; i < workData.length; i++) {
                var row = workData[i];
                var values = [
                    row.id,
                    dateToSerial(row.date),
                    row.group,
                    row.empId,
                    row.name,
                    row.shift,
                    row.woNo || '',
                    row.dept || '',
                    row.type,
                    row.content || '',
                    row.location || '',
                    row.orderTime || '',
                    row.startTime || '',
                    row.endTime || '',
                    row.status,
                    row.ot,
                    row.responseTime,
                    row.resTime || ''
                ];
                lines.push(values.join('\t'));
            }
            
            var textToCopy = lines.join('\n');
            
            // å˜—è©¦ç¾ä»£ APIï¼Œå¤±æ•—å‰‡é™ç´š
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(function() {
                    showAlert('âœ… å·²è¤‡è£½ ' + workData.length + ' è¡Œåˆ°å‰ªè²¼ç°¿ï¼ç›´æ¥è²¼å…¥ Excel å³å¯', 'success', 5000);
                }).catch(function() {
                    fallbackCopy(textToCopy);
                });
            } else {
                fallbackCopy(textToCopy);
            }
        }

        function fallbackCopy(text) {
            var textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.cssText = 'position:fixed;opacity:0;';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                var success = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (success) {
                    showAlert('âœ… å·²è¤‡è£½ ' + workData.length + ' è¡Œåˆ°å‰ªè²¼ç°¿ï¼', 'success', 5000);
                } else {
                    showAlert('âŒ è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½', 'error');
                }
            } catch (e) {
                document.body.removeChild(textarea);
                showAlert('âŒ ç€è¦½å™¨ä¸æ”¯æ´è‡ªå‹•è¤‡è£½', 'error');
            }
        }

        // ==========================================
        // äº‹ä»¶è™•ç†
        // ==========================================
        
        function parseAndFill() {
            var text = document.getElementById('inputDisplay').textContent;
            var result = parseInputText(text);
            fillDataFromParse(result);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            initData();
            initSpeechRecognition();
            
            var inputDisplay = document.getElementById('inputDisplay');
            inputDisplay.onclick = function() {
                if (this.textContent === 'è«‹èªªè©±æˆ–è¼¸å…¥å…§å®¹...') {
                    this.textContent = '';
                }
            };
        };
    </script>
</body>
</html>
