<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¾³é–€ç¶­ä¿®å ±å·¥åŠ©æ‰‹ Pro (PCç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@400;700&display=swap');
        body { font-family: 'Noto Sans HK', sans-serif; background-color: #f1f5f9; }
        .recording-active { animation: pulse 1.5s infinite; background-color: #fee2e2 !important; border-color: #ef4444 !important; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="p-4 lg:p-10">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-end mb-8">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tighter">MACAU REPAIR <span class="text-blue-600">PRO</span></h1>
                <p class="text-slate-500 font-medium">18 æ¬„ Excel å°æ¥ç‰ˆ Â· èªéŸ³ä¸æ–·ç·šæŠ€è¡“</p>
            </div>
            <div id="clock" class="text-2xl font-mono font-bold text-slate-300">00:00:00</div>
        </div>

        <div class="grid grid-cols-12 gap-8">
            <div class="col-span-12 lg:col-span-4 space-y-6">
                <div class="bg-white p-8 rounded-[2rem] shadow-xl border border-slate-200">
                    <div id="recordBtn" class="cursor-pointer group bg-slate-50 border-2 border-dashed border-slate-300 rounded-3xl p-10 transition-all hover:bg-blue-50 hover:border-blue-400 flex flex-col items-center">
                        <div id="micIcon" class="w-20 h-20 bg-white shadow-lg rounded-full flex items-center justify-center mb-4 transition-transform group-hover:scale-110">
                            <div id="micDot" class="w-5 h-5 bg-slate-300 rounded-full"></div>
                        </div>
                        <span id="statusText" class="text-slate-700 font-extrabold text-lg">æ’³ä¸€ä¸‹é–‹å§‹å ±å·¥</span>
                        <span class="text-slate-400 text-xs mt-2">è‡ªå‹•åµæ¸¬åœé “ï¼Œç„¡éœ€é‡è¦†å•Ÿå‹•</span>
                    </div>

                    <div class="mt-8">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">å¯¦æ™‚è½å¯« (å»£æ±è©±):</label>
                        <div id="interimBox" class="text-blue-500 italic text-sm min-h-[1.5rem] mt-1 px-1"></div>
                        <textarea id="finalTranscript" class="w-full h-48 mt-2 p-5 bg-slate-50 border-none rounded-2xl text-slate-800 focus:ring-2 focus:ring-blue-500 text-lg leading-relaxed shadow-inner" placeholder="è¬›å‡ºï¼šåœ°é»(é‚Šå±¤/é‚Šé–“æˆ¿)ã€æ™‚é–“ã€åšå’—å’©..."></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button id="analyseBtn" class="bg-blue-600 text-white py-4 rounded-2xl font-black text-lg hover:bg-blue-700 shadow-lg shadow-blue-200 active:scale-95 transition-all">æå–æ•¸æ“š</button>
                        <button id="resetBtn" class="bg-slate-200 text-slate-600 py-4 rounded-2xl font-black text-lg hover:bg-red-500 hover:text-white transition-all">æ¸…ç©º</button>
                    </div>
                </div>
                
                <div class="bg-amber-50 border border-amber-100 p-5 rounded-2xl">
                    <h4 class="text-amber-800 font-bold text-sm mb-1 uppercase">ğŸ’¡ å¸«å‚…æç¤º</h4>
                    <p class="text-amber-700 text-xs leading-5">è¬›å®Œã€Œåœ°é»ã€æˆ–ã€Œæ™‚é–“ã€å¯ä»¥åœä¸€åœï¼Œç³»çµ±æœƒè‡ªå‹•å¹«ä½ åˆ†é–‹å•²å­—ã€‚å¦‚æœ IT é–å’— USBï¼Œç”¨ã€Œè¤‡è£½æ•¸æ“šã€æ£å°±å¾—ã€‚</p>
                </div>
            </div>

            <div class="col-span-12 lg:col-span-8">
                <div class="bg-white rounded-[2rem] shadow-xl overflow-hidden border border-slate-200">
                    <div class="p-8 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                        <h2 class="font-black text-slate-800 text-xl tracking-tight">18 æ¬„æ©«å‘æ•¸æ“š (Excel å°ˆç”¨)</h2>
                        <div class="flex gap-3">
                            <button id="copyTabBtn" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition-all shadow-md flex items-center text-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                è¤‡è£½æ•¸æ“š
                            </button>
                            <button id="xlsxBtn" class="bg-green-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-green-700 transition-all shadow-md text-sm">
                                å°å‡º XLSX
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto p-4">
                        <table class="w-full text-sm text-left border-separate border-spacing-y-1" id="mainTable">
                            <thead class="text-slate-400 text-[10px] uppercase font-black tracking-widest">
                                <tr>
                                    <th class="px-6 py-3">Excel æ¬„ä½ (A - R)</th>
                                    <th class="px-6 py-3">è­˜åˆ¥çµæœ (å¯æŒ‰æ ¼ä¿®æ”¹)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50" id="tBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- åˆå§‹åŒ– 18 æ¬„æ¶æ§‹ ---
        const config = [
            { id: 'id', label: '1. #', val: '' },
            { id: 'date', label: '2. æ—¥æœŸ', val: '' },
            { id: 'group', label: '3. çµ„åˆ¥', val: '' },
            { id: 'staffId', label: '4. å“¡å·¥ç·¨è™Ÿ', val: '' },
            { id: 'staffName', label: '5. å§“å', val: '' },
            { id: 'shift', label: '6. æ›´', val: '' },
            { id: 'woNum', label: '7. å·¥å–®è™Ÿç¢¼', val: '' },
            { id: 'dept', label: '8. éƒ¨é–€', val: '' },
            { id: 'category', label: '9. å·¥ä½œåˆ†é¡ (PM/CMBD)', val: '' },
            { id: 'content', label: '10. å…§å®¹', val: '' },
            { id: 'location', label: '11. åœ°é»', val: '' },
            { id: 'tRec', label: '12. æ¥å–®æ™‚é–“', val: '' },
            { id: 'tStart', label: '13. é–‹å§‹ (+5 min)', val: '' },
            { id: 'tEnd', label: '14. å®Œæˆæ™‚é–“', val: '' },
            { id: 'status', label: '15. å·¥å–®ç‹€æ…‹', val: 'å·²å®Œæˆ' },
            { id: 'ot', label: '16. OT', val: '' },
            { id: 'respTime', label: '17. Response Time', val: '' },
            { id: 'resoTime', label: '18. Resolution Time', val: '' }
        ];

        const tBody = document.getElementById('tBody');
        config.forEach(item => {
            tBody.innerHTML += `
                <tr class="bg-white border border-slate-100 rounded-lg">
                    <td class="px-6 py-3 font-bold text-slate-400 text-[11px]">${item.label}</td>
                    <td class="px-6 py-3">
                        <input type="text" id="cell-${item.id}" value="${item.val}" class="w-full bg-transparent border-none focus:ring-2 focus:ring-blue-100 rounded px-2 py-1 text-slate-800 font-medium">
                    </td>
                </tr>
            `;
        });

        // --- èªéŸ³ä¸æ–·ç·šå¼•æ“ ---
        let recognition;
        let isRecording = false;
        const recordBtn = document.getElementById('recordBtn');
        const finalBox = document.getElementById('finalTranscript');
        const interimBox = document.getElementById('interimBox');

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'zh-HK';

            recognition.onresult = (e) => {
                let interim = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) {
                        finalBox.value += autoCorrect(e.results[i][0].transcript) + 'ï¼Œ';
                    } else {
                        interim += e.results[i][0].transcript;
                    }
                }
                interimBox.innerText = interim;
            };

            // è‡ªå‹•é‡å•ŸåŠŸèƒ½
            recognition.onend = () => {
                if (isRecording) recognition.start();
            };
        }

        function autoCorrect(t) {
            return t.replace(/åŸ·éƒµ/g, 'åŸ·æ²¹').replace(/è£œæ°´åˆ©/g, 'è£œæ°´æ³¥').replace(/æåº—/g, 'ææ‚').replace(/ä¹é»ä¸‰/g, '9é»15').replace(/åé»åŠ/g, '10é»30');
        }

        recordBtn.onclick = () => {
            if (!isRecording) {
                isRecording = true;
                recognition.start();
                recordBtn.classList.add('recording-active');
                document.getElementById('micDot').classList.replace('bg-slate-300', 'bg-red-500');
                document.getElementById('statusText').innerText = 'éŒ„éŸ³ä¸­... (åœå£å””é©šæ–·)';
            } else {
                isRecording = false;
                recognition.stop();
                recordBtn.classList.remove('recording-active');
                document.getElementById('micDot').classList.replace('bg-red-500', 'bg-slate-300');
                document.getElementById('statusText').innerText = 'æ’³ä¸€ä¸‹é–‹å§‹å ±å·¥';
            }
        };

        // --- æ•¸æ“šæå–é‚è¼¯ ---
        document.getElementById('analyseBtn').onclick = () => {
            const txt = finalBox.value;
            
            // åœ°é»æŠ“å– (æ™ºæ…§å‹)
            const loc = txt.match(/([A-Za-z0-9]+[F|æ¨“|å±¤|æˆ¿|B\d][^ï¼Œã€‚\s]*)/)?.[1] || '';
            
            // æ™‚é–“è™•ç†
            const rTime = extractTime(txt, 'æ¥å–®') || '09:00:00';
            const eTime = extractTime(txt, 'ææ‚|å®Œå·¥|å®Œæˆ') || '10:00:00';
            const sTime = addMins(rTime, 5); // è‡ªå‹•åŠ  5 åˆ†é˜

            const results = {
                date: new Date().toISOString().split('T')[0],
                woNum: txt.match(/å·¥å–®(\d+)/)?.[1] || '',
                category: txt.match(/å·¡æŸ¥|ä¿é¤Š/) ? 'PM' : 'CMBD',
                content: txt.match(/(åŸ·æ²¹|è£œæ°´æ³¥|æ¼æ°´|æ›ç‡ˆ|å·¡æŸ¥|ä¿é¤Š|ç¶­ä¿®|æ•´å˜¢|è·³æ£|å®‰è£)/)?.[0] || 'ç¶­ä¿®',
                location: loc,
                tRec: rTime,
                tStart: sTime,
                tEnd: eTime,
                respTime: formatDiff(rTime, sTime),
                resoTime: formatDiff(sTime, eTime)
            };

            Object.keys(results).forEach(key => {
                const input = document.getElementById(`cell-${key}`);
                if (input) input.value = results[key];
            });
        };

        function extractTime(text, key) {
            const m = text.match(new RegExp(`(\\d+é»[^ï¼Œã€‚\\s]*)\\s*${key}`));
            if (!m) return null;
            let raw = m[1];
            let h = raw.match(/(\d+)é»/)[1].padStart(2, '0');
            let min = "00";
            if (raw.includes('åŠ')) min = "30";
            else if (raw.includes('3') || raw.includes('ä¸‰') || raw.includes('15')) min = "15";
            else if (raw.includes('9') || raw.includes('ä¹') || raw.includes('45')) min = "45";
            else {
                let mm = raw.match(/é»(\d+)/);
                if (mm) min = mm[1].padStart(2, '0');
            }
            return `${h}:${min}:00`;
        }

        function addMins(t, m) {
            let [hh, mm] = t.split(':').map(Number);
            let d = new Date(); d.setHours(hh, mm + m);
            return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:00`;
        }

        function formatDiff(s, e) {
            const [h1, m1] = s.split(':').map(Number);
            const [h2, m2] = e.split(':').map(Number);
            let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
            if (diff < 0) diff = 0;
            let hh = Math.floor(diff / 60).toString().padStart(2, '0');
            let mm = (diff % 60).toString().padStart(2, '0');
            return `${hh}:${mm}:00`;
        }

        // --- å°å‡ºèˆ‡è¤‡è£½ ---
        document.getElementById('copyTabBtn').onclick = () => {
            const vals = config.map(c => document.getElementById(`cell-${c.id}`).value);
            navigator.clipboard.writeText(vals.join('\t')).then(() => alert('å·²è¤‡è£½æ©«å‘ 18 æ¬„æ•¸æ“šï¼\nè«‹å–º Excel æ€ä¸€æ ¼æŒ‰ Ctrl+Vã€‚'));
        };

        document.getElementById('xlsxBtn').onclick = () => {
            const vals = config.map(c => document.getElementById(`cell-${c.id}`).value);
            const ws = XLSX.utils.aoa_to_sheet([config.map(c => c.label), vals]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");
            XLSX.writeFile(wb, `Repair_Report_${Date.now()}.xlsx`);
        };

        document.getElementById('resetBtn').onclick = () => {
            finalBox.value = '';
            interimBox.innerText = '';
            config.forEach(c => {
                const input = document.getElementById(`cell-${c.id}`);
                if (c.id === 'status') input.value = 'å·²å®Œæˆ';
                else input.value = '';
            });
        };

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'); }, 1000);
    </script>
</body>
</html>
